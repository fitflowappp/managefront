{"version":3,"sources":["../src/server.js"],"names":["compression","require","server","global","http","agent","Agent","maxSockets","Number","MAX_VALUE","httpProxy","apiProxy","createProxyServer","target","ignorePath","changeOrigin","on","error","req","res","json","headersSent","writeHead","reason","message","end","all","url","replace","web","process","env","NODE_ENV","webpack","webpackDevMiddleware","webpackHotMiddleware","config","compiler","use","noInfo","publicPath","output","watchOptions","aggregateTimeout","poll","static","__dirname","setRawCookie","headers","cookie","save","routes","location","err","redirectLocation","renderProps","status","redirect","pathname","search","store","arr","components","component","serverInit","Array","concat","push","map","Function","dispatch","catch","then","html","head","rewind","renderFullPage","getState","initialState","title","toString","listen","console"],"mappings":"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","file":"server.js","sourcesContent":["/**\r\n * Created by john on 2016/5/16.\r\n */\r\nimport express from 'express';\r\nimport React from 'react';\r\nimport {renderToString} from 'react-dom/server';\r\nimport {Provider} from 'react-redux';\r\nimport configureStore from './store/configureStore';\r\nimport {RouterContext, match} from 'react-router';\r\nimport routes from './routes';\r\nimport cookie from 'react-cookie'\r\nimport Helmet from 'react-helmet'\r\nimport {port, apiURL} from './config'\r\n// var proxy = require('http-proxy-middleware');\r\nvar compression = require('compression')\r\nconst server = global.server = express();\r\nvar http = require('http');\r\nvar agent = new http.Agent({maxSockets: Number.MAX_VALUE});\r\n//api服务器代理 若使用nginx代理接口,fetch配置需要根据客户端和服务端 配置api地址\r\n// server.use('/bwm',proxy({target: apiURL, changeOrigin: true}));\r\n// server.use('/api',proxy({\r\n//     target: apiURL, // target host\r\n//     changeOrigin: false,               // needed for virtual hosted sites\r\n//     ws: false,                         // proxy websockets\r\n//     pathRewrite: {\r\n//         '^/api' : '/bwm/manage'     // rewrite path\r\n//         // '^/remove/api' : '/api'       // remove path\r\n//     },\r\n//     onError:function onError(err, req, res) {\r\n//         res.writeHead(500, {\r\n//             'Content-Type': 'text/plain'\r\n//         });\r\n//         res.end('Something went wrong.');\r\n//     }\r\n//     // proxyTable: {\r\n//     //     // when request.headers.host == 'dev.localhost:3000',\r\n//     //     // override target 'http://www.example.org' to 'http://localhost:8000'\r\n//     //     'dev.localhost:3000' : 'http://localhost:8000'\r\n//     // }\r\n// }));\r\nvar httpProxy = require('http-proxy');\r\n\r\nvar apiProxy = httpProxy.createProxyServer({\r\n    target: apiURL,\r\n    ignorePath: false,\r\n    agent: agent,\r\n    changeOrigin:true\r\n    // prependPath: false\r\n    // {\r\n    //     host: '101.69.182.82',\r\n    //     port: 9090\r\n    // }\r\n    //target:\"http://101.69.182.82:9090\",\r\n    //url = url.replace(\"/api/\",\"/bwm/manage/\");\r\n\r\n});\r\n\r\n\r\napiProxy.on('error', (error, req, res) => {\r\n    let json;\r\n    if (!res.headersSent) {\r\n        res.writeHead(500, {'content-type': 'application/json'});\r\n    }\r\n    json = {error: 'proxy_error', reason: error.message};\r\n    res.end(JSON.stringify(json));\r\n});\r\n\r\nserver.all(\"/api/*\", function (req, res) {\r\n    var url = req.url;\r\n    url = url.replace(\"/api/\", \"/\");\r\n    req.url = url;\r\n    apiProxy.web(req, res);\r\n    // return httpProxy.web(req, res , { target: \"http://another-domain:8000\" } );\r\n});\r\n/*server.all(\"/bbs/!*\", function (req, res) {\r\n    // var url = req.url;\r\n    // url = url.replace(\"/bbs/\", \"/bbs/\");\r\n    // req.url = url;\r\n    apiProxy.web(req, res);\r\n    // return httpProxy.web(req, res , { target: \"http://another-domain:8000\" } );\r\n});\r\n\r\nserver.all(\"/front/!*\", function (req, res) {\r\n    var url = req.url;\r\n    url = url.replace(\"/front/\", \"/bbs/\");\r\n    req.url = url;\r\n    apiProxy.web(req, res);\r\n    // return httpProxy.web(req, res , { target: \"http://another-domain:8000\" } );\r\n});*/\r\nserver.all(\"/public/view/*\", function (req, res) {\r\n    // var url = req.url;\r\n    // url = url.replace(\"/view/\", \"/view/\");\r\n    // req.url = url;\r\n    apiProxy.web(req, res);\r\n    // return httpProxy.web(req, res , { target: \"http://another-domain:8000\" } );\r\n});\r\nserver.all(\"/view/*\", function (req, res) {\r\n    // var url = req.url;\r\n    // url = url.replace(\"/view/\", \"/view/\");\r\n    // req.url = url;\r\n    apiProxy.web(req, res);\r\n    // return httpProxy.web(req, res , { target: \"http://another-domain:8000\" } );\r\n});\r\nif (process.env.NODE_ENV !== \"production\") {\r\n    var webpack = require('webpack');\r\n    var webpackDevMiddleware = require('webpack-dev-middleware');\r\n    var webpackHotMiddleware = require('webpack-hot-middleware');\r\n    var config = require('../webpack.dev.config');\r\n    var compiler = webpack(config);\r\n    server.use(webpackDevMiddleware(compiler, {\r\n        noInfo: true, publicPath: config.output.publicPath,\r\n        watchOptions: {\r\n            aggregateTimeout: 300,\r\n            poll: true\r\n        }\r\n    }));\r\n    server.use(webpackHotMiddleware(compiler));\r\n}\r\n/**\r\n *  静态文件可使用nginx代理或者直接用node，效率未测试\r\n *    server {\r\n\r\n        listen 9000;\r\n        server_name 192.168.1.99:9000;\r\n\r\n        location / {\r\n\t\t\tproxy_pass    http://192.168.1.99:3000/;\r\n            proxy_redirect default ;\r\n        }\r\n\t\tlocation /dist/ {\r\n\t\t\talias D:/WebstormProjects/react-redux/dist/;\r\n\t\t}\r\n    }\r\n */\r\nserver.use(compression());\r\nserver.use('/dist', express.static(__dirname + '/dist'));\r\n\r\n\r\nserver.use((req, res) => {\r\n    cookie.setRawCookie(req.headers.cookie);\r\n    cookie.save = res.cookie;\r\n    match({routes, location: req.url}, (err, redirectLocation, renderProps) => {\r\n        if (err) {\r\n            res.status(500).end(`Internal Server Error ${err}`);\r\n        } else if (redirectLocation) {\r\n            res.redirect(redirectLocation.pathname + redirectLocation.search);\r\n        } else if (renderProps) {\r\n            const store = configureStore();\r\n            // const state = store.getState();\r\n            var arr = [];\r\n            for (var component of renderProps.components) {\r\n                if (component && component.serverInit) {\r\n                    if (component.serverInit instanceof Array) {\r\n                        arr = arr.concat(component.serverInit)\r\n                    } else {\r\n                        arr.push(component.serverInit)\r\n                    }\r\n                }\r\n            }\r\n            Promise.all(arr.map(function (serverInit) {\r\n                    if (serverInit instanceof Function)\r\n                        return store.dispatch(serverInit(renderProps))\r\n                }))\r\n                .catch(function (status) {\r\n                    if (status == 401) {\r\n                        res.redirect(\"/login\");\r\n                    }\r\n                })\r\n                .then(() => {\r\n                    const html = renderToString(\r\n                        <Provider store={store}>\r\n                            <RouterContext {...renderProps} />\r\n                        </Provider>\r\n                    );\r\n                    let head = Helmet.rewind();\r\n                    res.end(renderFullPage(html, head, store.getState()));\r\n                })\r\n        } else {\r\n            res.status(404).end('Not found');\r\n        }\r\n    });\r\n});\r\n\r\nfunction renderFullPage(html, head, initialState) {\r\n    return `\r\n    <!DOCTYPE html>\r\n    <html>\r\n    <head>\r\n      <meta charset=\"UTF-8\">\r\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n      ${head.title.toString()}\r\n        <link href=\"/dist/stylesheets/bootstrap.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n        <link href=\"/dist/stylesheets/datatables.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n        <link href=\"/dist/stylesheets/AdminLTE.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n        <link href=\"/dist/stylesheets/_all-skins.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n        <link rel=\"stylesheet\" href=\"//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css\" integrity=\"sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN\" crossorigin=\"anonymous\">\r\n        <link rel=\"stylesheet\" href=\"//cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css\">\r\n        <link href=\"/dist/stylesheets/app.css\" media=\"screen, projection\" rel=\"stylesheet\" type=\"text/css\" />\r\n        <link rel=\"shortcut icon\" href=\"/dist/favicon.ico\">\r\n        <!--[if IE]>\r\n            <link href=\"/dist/stylesheets/ie.css\" media=\"screen, projection\" rel=\"stylesheet\" type=\"text/css\" />\r\n        <![endif]-->\r\n    </head>\r\n    <body class='sidebar-mini skin-blue'>\r\n      <div id=\"root\">\r\n        <div>\r\n          ${html}\r\n        </div>\r\n      </div>\r\n      <script>\r\n        window.__INITIAL_STATE__ = ${JSON.stringify(initialState)};\r\n      </script>\r\n      <script src=\"/dist/bundle.js\"></script>\r\n      <script src=\"/dist/jquery.js\"></script>\r\n      <script src=\"/dist/bootstrap.js\"></script>\r\n       <script src=\"/dist/adminlte.js\"></script>\r\n    </body>\r\n    </html>\r\n  `;\r\n}\r\n\r\n// This is fired every time the server side receives a request\r\nserver.listen(port, (error) => {\r\n    if (error) {\r\n        console.error(error)\r\n    } else {\r\n        //console.info(`==>  Listening on port ${port}. Open up http://localhost:${port}/ in your browser.`)\r\n    }\r\n});"]}