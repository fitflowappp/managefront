{"version":3,"sources":["../../src/common/fetch.js"],"names":["fetch","apiFactory","upload","postAPI","getAPI","putAPI","deleteAPI","headers","auth_token","conf","baseURL","timeout","process","env","BROWSER","create","handleError","dispatch","error","status","fetchSetAfterMethod","promise","after","success","then","response","data","method","successCB","errorCB","actions","_url","_params","keys","params","url","match1","match","i","key","replace","match2","map","request_action","receive_action","error_action","get","_","Date","getTime","catch","err","e","progressCb","FormData","file","target","files","length","append","config","progress","progressEvent","percentCompleted","loaded","total","post"],"mappings":"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","file":"fetch.js","sourcesContent":["/**\r\n * Created by john on 2016/5/19.\r\n */\r\nimport axios from 'axios';\r\nimport {port} from \"../config\"\r\nimport {getMToken, logout} from \"../common/auth\";\r\n\r\nexport function fetch() {\r\n    var headers = {\r\n        'Content-Type': 'application/json'\r\n    };\r\n    var auth_token = getMToken();\r\n    if (auth_token) {\r\n        headers['Authorization'] = auth_token;\r\n    }\r\n    var conf = {\r\n        baseURL: \"http://localhost:\" + port + \"/\",\r\n        timeout: 60000,\r\n        headers\r\n    };\r\n    if (process.env.BROWSER) {\r\n        delete conf[\"baseURL\"];\r\n    }\r\n    return axios.create(\r\n        conf\r\n    );\r\n}\r\n\r\nfunction handleError(dispatch, error) {\r\n    if (process.env.BROWSER) {\r\n        if (error.status == 404) {\r\n        } else if (error.status == 401) {\r\n            dispatch(logout());\r\n            // dispatch(dispatch => {\r\n            //     dispatch({type: \"LOGOUT\"});\r\n            //     // cookie.remove(\"mtoken\");\r\n            //     cookie.remove(\"muser\",{\"path\": '/'});\r\n            //     browserHistory.push('/login');\r\n            // });\r\n        }\r\n    } else {\r\n        throw error.status\r\n    }\r\n}\r\n\r\nfunction fetchSetAfterMethod(promise) {\r\n    promise.after = function (success, error) {\r\n        if (!error) {\r\n            this.then(function (response) {\r\n                success(response.data, response.status, response.headers);\r\n            });\r\n        } else {\r\n            this.then(function (response) {\r\n                let status = response.status;\r\n                if (status >= 200 && status < 300 || status === 304) {\r\n                    if (success)\r\n                        success(response.data, response.status, response.headers);\r\n                } else {\r\n                    if (error)\r\n                        error(response.data, response.status, response.headers);\r\n                }\r\n            });\r\n        }\r\n        return promise;\r\n    };\r\n    return promise;\r\n}\r\n\r\nexport function apiFactory(method, successCB, errorCB, actions = [], _url, _params, keys) {\r\n    var params = Object.assign({},_params);\r\n    var url =  _url;\r\n    var match1 = url.match(/\\/\\:[a-zA-Z]+/g);\r\n    if (match1 && _params) {\r\n        for (let i of match1) {\r\n            let key = i.replace(\"/:\", \"\");\r\n            if (params[key]) {\r\n                url = url.replace(i, \"/\" + params[key]);\r\n                delete params[key];\r\n            }\r\n        }\r\n    }\r\n\r\n    var match2 = url.match(/\\/\\:[a-zA-Z]+/g);\r\n\r\n    if (match2) {\r\n        for (let i in match2) {\r\n            url = url.replace(match2[i], \"\");\r\n        }\r\n    }\r\n    // if (params) {\r\n    //     for (let i in params) {\r\n    //         url = url.replace(\"/:\" + i, \"/\" + params[i]);\r\n    //     }\r\n    // }\r\n    //\r\n    // var _p = url.match(/\\/\\:[a-zA-Z]+/g);\r\n    // if (_p) {\r\n    //     for (let i in _p) {\r\n    //         url = url.replace(_p[i], \"\");\r\n    //     }\r\n    // }\r\n\r\n    keys && (keys = keys.map(key => params[key]));\r\n\r\n    var request_action;\r\n    var receive_action;\r\n    var error_action;\r\n    actions[0] && (receive_action = actions[0]);\r\n    actions[1] && (request_action = actions[1]);\r\n    actions[2] && (error_action = actions[2]);\r\n    return dispatch => {\r\n        if (request_action)\r\n            dispatch(request_action());\r\n\r\n\r\n        if (method === \"get\") {\r\n            const promise = fetch().get(url, {params: {...params, _: new Date().getTime()}})\r\n                .then(function (response) {\r\n                    dispatch(receive_action(response.data, keys));\r\n                    let status = response.status;\r\n                    if (status >= 200 && status < 300 || status === 304) {\r\n                        if (successCB)\r\n                            successCB(response.data, response.status, response.headers);\r\n                    } else {\r\n                        if (errorCB)\r\n                            errorCB(response.data, response.status, response.headers);\r\n                    }\r\n                    return response;\r\n\r\n                })\r\n                .catch(function (err) {\r\n                    handleError(dispatch, err);\r\n                    if (error_action) {\r\n                        dispatch(error_action(err, keys));\r\n                    }\r\n                    if (errorCB)\r\n                        errorCB(err.data, err.status, err.headers);\r\n                    return err;\r\n                });\r\n            // fetchSetAfterMethod(promise);\r\n\r\n\r\n            return promise\r\n        } else {\r\n            const promise = fetch()[method](url, params)\r\n                .then(function (response) {\r\n                    if (method === \"delete\") {\r\n                        dispatch(receive_action(response.data, params, keys));\r\n                    } else {\r\n                        dispatch(receive_action(response.data, keys));\r\n                    }\r\n\r\n                    let status = response.status;\r\n                    if (status >= 200 && status < 300 || status === 304) {\r\n                        if (successCB)\r\n                            successCB(response.data, response.status, response.headers);\r\n                    } else {\r\n                        if (errorCB)\r\n                            errorCB(response.data, response.status, response.headers);\r\n                    }\r\n                    return response;\r\n                })\r\n                .catch(function (err) {\r\n                    handleError(dispatch, err);\r\n                    if (error_action) {\r\n                        dispatch(error_action(err, keys));\r\n                    }\r\n                    if (errorCB)\r\n                        errorCB(err.data, err.status, err.headers);\r\n                    return err;\r\n\r\n                });\r\n            // fetchSetAfterMethod(promise);\r\n\r\n\r\n            return promise;\r\n        }\r\n\r\n    }\r\n}\r\n\r\n\r\n/**\r\n * 文件上传接口\r\n * @param fileId\r\n * @param e\r\n * @returns {*|axios.Promise}\r\n * uploadFile(e){\r\n *      upload(e).then(function (res) {\r\n *\r\n *      }).catch(function (error) {\r\n *\r\n *      })\r\n * }\r\n * <FormControl type=\"file\" id=\"headerImg\" onChange={this.uploadFile.bind(this)}/>\r\n */\r\nexport function upload(e, progressCb) {\r\n    const data = new FormData();\r\n    const file = e.target;\r\n    for (var i = 0; i < file.files.length; i++) {\r\n        data.append('file', file.files[i]);\r\n    }\r\n    const config = {\r\n        progress: function (progressEvent) {\r\n            var percentCompleted = progressEvent.loaded / progressEvent.total;\r\n            if(progressCb){\r\n                progressCb(percentCompleted);\r\n            }\r\n        },\r\n    };\r\n\r\n    var promise = fetchSetAfterMethod(\r\n        fetch().post('/api/manage/upload', data, config)\r\n            .then(function (response) {\r\n                return response;\r\n            }).catch(function (response) {\r\n            return response;\r\n        })\r\n    );\r\n    // promise.after = function (success, error) {\r\n    //     if (!error) {\r\n    //         this.then(function (response) {\r\n    //             success(response.data, response.status, response.headers);\r\n    //         });\r\n    //     } else {\r\n    //         this.then(function (response) {\r\n    //             let status = response.status;\r\n    //             if (status >= 200 && status < 300 || status === 304) {\r\n    //                 if (success)\r\n    //                     success(response.data, response.status, response.headers);\r\n    //             } else {\r\n    //                 if (error)\r\n    //                     error(response.data, response.status, response.headers);\r\n    //             }\r\n    //         });\r\n    //     }\r\n    //     return promise;\r\n    // };\r\n\r\n    return promise;\r\n}\r\n\r\nexport function postAPI(success,error,actions = [], url, params, keys) {\r\n    return apiFactory(\"post\",success,error, actions, url, params, keys);\r\n}\r\n\r\nexport function getAPI(success,error,actions = [], url, params, keys) {\r\n    return apiFactory(\"get\",success,error, actions, url, params,keys);\r\n}\r\nexport function putAPI(success,error,actions = [], url, params,  keys) {\r\n    return apiFactory(\"put\",success,error, actions, url, params, keys);\r\n}\r\nexport function deleteAPI(success,error,actions = [], url, params, keys) {\r\n    return apiFactory(\"delete\",success,error, actions, url, params, keys);\r\n}\r\n"]}